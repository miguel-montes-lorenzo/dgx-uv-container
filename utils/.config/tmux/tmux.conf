# ~/.config/tmux/tmux.conf (DGX/container-safe + vendored tmux-session-wizard)

unbind -a -T prefix
unbind -a -T root

# --- General ---
set -g xterm-keys on
set -g set-clipboard on
set -g escape-time 100
set -g status-interval 10

# --- Display ---
# set -g default-terminal "tmux-256color"
# set -as terminal-features '*:RGB'
set -g allow-passthrough on
set -ga update-environment TERM
set -ga update-environment TERM_PROGRAM

# --- Prefix ---
unbind C-b
set -g prefix C-F1

# --- Session ---
bind _ detach
bind -n M-F2 detach
bind C-_ confirm-before -p "Kill session #{session_name}? (y/n)" "kill-session"

unbind r
bind l if-shell "test -n \"$TMUX_CONF\"" \
  "source-file \"$TMUX_CONF\"; display-message 'tmux config reloaded'" \
  "source-file ~/.config/tmux/tmux.conf; display-message 'tmux config reloaded'"

bind r command-prompt -I "#W" "rename-window '%%'"
bind R command-prompt -I "#S" "rename-session '%%'"

# NOTE: Removed the session-created interactive rename hook to avoid unexpected
# blocking prompts in remote/container usage.

# --- Help ---
bind-key -T prefix '?' display-popup -w 140 -h 20 -x C -y C \
  -E 'sh -lc "tmux -L \"#{socket_name}\" list-keys 2>&1 | { command -v less >/dev/null 2>&1 && less -R || cat; }"'

# --- Panes ---
bind -n M-h split-window -h -c "#{pane_current_path}"
bind -n M-v split-window -v -c "#{pane_current_path}"
bind -n M-w kill-pane
bind -n M-- resize-pane -L 5
bind -n M-+ resize-pane -R 5
bind -n M-Left  if-shell -F '#{pane_at_left}'   'select-pane -R' 'select-pane -L'
bind -n M-Right if-shell -F '#{pane_at_right}'  'select-pane -L' 'select-pane -R'
bind -n M-Up    if-shell -F '#{pane_at_top}'    'select-pane -D' 'select-pane -U'
bind -n M-Down  if-shell -F '#{pane_at_bottom}' 'select-pane -U' 'select-pane -D'

# --- Windows ---
bind n new-window -c "#{pane_current_path}"
bind w kill-window
bind -n M-F1 next-window
bind -n C-M-F1 previous-window

# --- Mouse / Scroll ---
set -g mouse on
bind -n M-m set -g mouse \; display-message "mouse: #{?mouse,on,off}"
bind -n WheelUpPane if-shell -F -t = "#{mouse_any_flag}" \
  "send-keys -M" \
  "if -Ft= '#{pane_in_mode}' 'send-keys -M' 'copy-mode -e; send-keys -M'"

# --- Copy / Paste ---
# Start selection with a mouse drag
bind -T root MouseDrag1Pane \
  if -F "#{pane_in_mode}" \
    "send -X begin-selection" \
    "copy-mode -e; send -X begin-selection"

# WSL-only clipboard integration (disabled on DGX/container by default).
# If you ever run this config inside WSL, these binds will enable automatically.
if-shell '[ -d /mnt/c ]' \
  'bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel "/mnt/c/Windows/System32/clip.exe"' \
  ''

if-shell '[ -d /mnt/c ]' \
  'bind -T root MouseDown3Pane run-shell "(/mnt/c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe -NoProfile -Command Get-Clipboard | tr -d ''\r'' | python3 -c ''import sys; data = sys.stdin.read(); sys.stdout.write(data.rstrip(\"\\n\"))'') | tmux load-buffer -" \; paste-buffer' \
  ''

if-shell '[ -d /mnt/c ]' \
  'bind -T root C-MouseDown3Pane run-shell "(/mnt/c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe -NoProfile -Command Get-Clipboard | tr -d ''\r'' | python3 -c ''import sys; data = sys.stdin.read(); sys.stdout.write(data.rstrip(\"\\n\"))'') | tmux load-buffer -" \; paste-buffer' \
  ''

# --- Command Mode ---
bind : command-prompt

# --- Copy Mode ---
bind v copy-mode \; display-message 'entered copy mode'
bind -T copy-mode-vi q send-keys -X cancel \; display-message 'exited copy mode'
bind -T copy-mode q send-keys -X cancel \; display-message 'exited copy mode'
bind -T copy-mode-vi Enter send-keys -X copy-selection-and-cancel \; display-message 'exited copy mode'
bind -T copy-mode Enter send-keys -X copy-selection-and-cancel \; display-message 'exited copy mode'

# --- Hooks ---
# Start every pane/window with a clean env, POSIX-safe
set -g default-command 'sh -c "
  ve=\${VIRTUAL_ENV-}
  cp=\${CONDA_PREFIX-}

  unset VIRTUAL_ENV VIRTUAL_ENV_PROMPT CONDA_PREFIX CONDA_DEFAULT_ENV MAMBA_DEFAULT_ENV \
        PYTHONHOME PYTHONPATH UV_ACTIVE UV_PROJECT UV_PYTHON PIXI_PREFIX PIXI_ENV

  oldpath=\$PATH
  newpath=

  IFS=:
  set -f
  for d in \$oldpath; do
    skip=0
    if [ -n \"\$ve\" ] && [ \"\$d\" = \"\$ve/bin\" ]; then skip=1; fi
    if [ -n \"\$cp\" ] && [ \"\$d\" = \"\$cp/bin\" ]; then skip=1; fi
    case \"\$d\" in
      */.venv/bin) skip=1 ;;
    esac
    if [ \$skip -eq 0 ]; then
      if [ -n \"\$newpath\" ]; then newpath=\$newpath:\$d; else newpath=\$d; fi
    fi
  done
  unset IFS
  set +f
  export PATH=\$newpath

  exec \"\$SHELL\" -l
"'

# --- Plugins (vendored; no TPM; no network) ---
# tmux-session-wizard
# (Your plugin folder: ~/.config/tmux/plugins/tmux-session-wizard/)
set -g @session-wizard 's'
if-shell '[ -f "$HOME/.config/tmux/plugins/tmux-session-wizard/session-wizard.tmux" ]' \
  'run-shell -b "$HOME/.config/tmux/plugins/tmux-session-wizard/session-wizard.tmux"' \
  'display-message "tmux-session-wizard not found: ~/.config/tmux/plugins/tmux-session-wizard/session-wizard.tmux"'

# If you later want minimal-tmux-status (vendored), enable this:
if-shell '[ -f "$HOME/.config/tmux/plugins/minimal-tmux-status/minimal.tmux" ]' \
  'run-shell -b "$HOME/.config/tmux/plugins/minimal-tmux-status/minimal.tmux"' \
  'display-message "minimal-tmux-status not found (vendored path missing)"'

# --- Custom Utilities ---
# Safe-load (only if present + executable)
if-shell '[ -x "$HOME/.config/tmux/utils/custom-status/custom-status.sh" ]' \
  'run-shell -b "$HOME/.config/tmux/utils/custom-status/custom-status.sh"' \
  ''
