name: ${COMPOSE_PROJECT_NAME}

services:
  ubuntu:
    # container_name: ${USER}-${PWD}-container  # comment to fallback to default naming: <project>_<service>_<index>
    image: dgx-ubuntu  # comment to fallback to default naming: <project>_<service>
    build:
      context: .
      args:
        UID: ${HOST_UID}
        GID: ${HOST_GID}
        USERNAME: "${CONTAINER_USER}"
    networks: [alumnos]

    volumes:
      - ${HOST_VOLUME_PATH}:/mnt/workdata/
      - ./utils/:/mnt/utils/

    environment:
      - USER=${CONTAINER_USER}
      - CONTAINER_USER=${CONTAINER_USER}

      - COMPOSE_STATE_DIR=${COMPOSE_STATE_DIR}

      - UV_CACHE_DIR=/mnt/workdata/${UV_CACHE_SUBDIR}
      - UV_LINK_MODE=hardlink

      - PERSISTENT_UV_CACHE=${PERSISTENT_UV_CACHE}  # ??

      # cleanup cache everytime a 
      # - PERSISTENT_CACHE=true
      - COMPOSE_STATE_DIR=${COMPOSE_STATE_DIR}
      - CLEANUP_STATE_DIR=${CLEANUP_STATE_DIR}
      - CACHE_CLEANUP_TIME=${CACHE_CLEANUP_TIME}

      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - DISPLAY_INFO_AT_STARTUP=true

    user: "root"

    command:
      - bash
      - -lc
      - |
          set -Eeuo pipefail

          mkdir -p "$$(dirname -- "$${COMPOSE_STATE_DIR}")"
          printf '%s\n' true > "$${COMPOSE_STATE_DIR}"
          echo true > ${COMPOSE_STATE_DIR}

          HOME="/home/$$CONTAINER_USER"
          mkdir -p $$HOME
          chown -R "${HOST_UID}:${HOST_GID}" $$HOME || true
          chmod 755 $$HOME || true


          # SET UP UTILS VOLUME

          rm -f $$HOME/.bashrc
          cp /mnt/utils/system/.bashrc $$HOME/.bashrc
          cp /mnt/utils/system/bash.bashrc /etc/bash.bashrc

          rm -rf $$HOME/.config
          mkdir -p $$HOME/.config
          cp -a /mnt/utils/.config/. $$HOME/.config/


          # SET UP WORKDATA VOLUME

          mkdir -p \
            /mnt/workdata/${DATA_SUBDIR} \
            /mnt/workdata/${UV_CACHE_SUBDIR} \
            /mnt/workdata/${SSH_SUBDIR}

          rm -rf $$HOME/data
          ln -sfn /mnt/workdata/${DATA_SUBDIR} $$HOME/data

          mkdir -p $$HOME/.cache
          rm -rf $$HOME/.cache/uv
          # ln -sfn /mnt/workdata/${UV_CACHE_SUBDIR} $$HOME/.cache/uv

          rm -rf $$HOME/.ssh
          ln -sfn /mnt/workdata/${SSH_SUBDIR} $$HOME/.ssh

          chown -R ${HOST_UID}:${HOST_GID} /mnt/workdata || true
          chown -R ${HOST_UID}:${HOST_GID} $$HOME || true

          chmod 700 /mnt/workdata/${SSH_SUBDIR}
          chmod 600 /mnt/workdata/${SSH_SUBDIR}/* 2>/dev/null || true


          # SET UP UV
          su - "${CONTAINER_USER}" -s /bin/bash -c '
            set -Eeuo pipefail
            # Force correct HOME even if something preserves environment incorrectly
            export HOME="/home/'"${CONTAINER_USER}"'"
            export USER="'"${CONTAINER_USER}"'"
            export PATH="$HOME/.local/bin:$PATH"
            export UV_CACHE_DIR="/mnt/workdata/${UV_CACHE_SUBDIR}"
            # Make sure the file exists (better error)
            test -f "$$HOME/.config/uv/install.sh"
            echo "$$HOME/.config/uv/install.sh"
            source "$$HOME/.config/uv/install.sh"
            uv tool install ruff --force
            uv tool install ty --force
            uv tool install black --force
            uv tool install pytest --force
            uv tool install "dvc[ssh,s3]" --force
            source "$$HOME/.config/uv/define-functions.sh"
            command -v uncache >/dev/null 2>&1 && uncache >/dev/null  # silent success & visible failure
          '


          echo "uv setup done"


          # systemd-run --user --unit=myjob --replace your_command 

          # SET UP CLEANUP CACHE TIMER
          # (runs in background; no systemd required)

          mkdir -p /run/control/src /run/control/var /run/control/log

          # Make /run/control/log writable for the hook (runs as $CONTAINER_USER).
          # Keep it simple and reliable: log dir is ephemeral anyway.
          chmod 777 /run/control/log

          # Ensure the hook log file exists and is writable by $CONTAINER_USER
          install -m 666 /dev/null /run/control/log/cache-cleanup.log || true

          # Copy control scripts from the bind-mounted utils volume
          cp -f /mnt/utils/control/cache-cleanup-hook.sh /run/control/src/cache-cleanup-hook.sh
          cp -f /mnt/utils/control/cache-cleanup-timer.sh /run/control/src/cache-cleanup-timer.sh
          chmod 755 /run/control/src/cache-cleanup-hook.sh /run/control/src/cache-cleanup-timer.sh

          # Initialize shared countdown state (used by all terminals + timer)
          : "$${CLEANUP_STATE_DIR:=/run/control/var/cache-cleanup-time}"
          : "$${CACHE_CLEANUP_TIME:=3600}"
          mkdir -p "$$(dirname -- "$${CLEANUP_STATE_DIR}")"
          printf '%s\n' "$${CACHE_CLEANUP_TIME}" > "$${CLEANUP_STATE_DIR}"

          # Allow the interactive user to reset the timer via the bashrc hook
          _cg="$$(id -gn "$${CONTAINER_USER}" 2>/dev/null || echo "$${CONTAINER_USER}")"
          chown "$${CONTAINER_USER}:$${_cg}" "$${CLEANUP_STATE_DIR}" 2>/dev/null || true
          chmod 664 "$${CLEANUP_STATE_DIR}" 2>/dev/null || true
          : > "$${CLEANUP_STATE_DIR}.lock"
          chown "$${CONTAINER_USER}:$${_cg}" "$${CLEANUP_STATE_DIR}.lock" 2>/dev/null || true
          chmod 664 "$${CLEANUP_STATE_DIR}.lock" 2>/dev/null || true

          # Start timer in background (do not block the container startup)
          setsid -f /run/control/src/cache-cleanup-timer.sh \
            --state-file="$${CLEANUP_STATE_DIR}" \
            --timeout="$${CACHE_CLEANUP_TIME}" \
            --hook="/run/control/src/cache-cleanup-hook.sh" \
            --user="$${CONTAINER_USER}" \
            --home="/home/$${CONTAINER_USER}" \
            --tick="10" \
            >/run/control/log/cache-cleanup-timer.stdout.log 2>&1 || true



          # ???

          echo done

          printf '%s\n' false > "$${COMPOSE_STATE_DIR}"
          exec su -s /bin/bash ${CONTAINER_USER} -c "sleep infinity"

networks:
  alumnos:
    external: true